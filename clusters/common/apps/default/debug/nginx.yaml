apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: default
  labels:
    app: nginx
  annotations:
    tailscale.com/proxy-group: common-ingress
    tailscale.com/hostname: ${LOCATION}-nginx
spec:
  type: LoadBalancer
  loadBalancerClass: tailscale
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
  selector:
    app: nginx
---
# apiVersion: v1
# kind: Service
# metadata:
#   name: to-use1-nginx
#   annotations:
#     # tailscale.com/tailnet-fqdn: use1-nginx.raj.ts.net
#     tailscale.com/tailnet-ip: 100.82.116.108
#     tailscale.com/proxy-group: common-egress
# spec:
#   externalName: placeholder
#   type: ExternalName
#   ports:
#   - name: http
#     port: 80
#     protocol: TCP
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: to-usw2-nginx
#   annotations:
#     # tailscale.com/tailnet-fqdn: usw2-nginx.raj.ts.net
#     tailscale.com/tailnet-ip: 100.82.116.107
#     tailscale.com/proxy-group: common-egress
# spec:
#   externalName: placeholder
#   type: ExternalName
#   ports:
#   - name: http
#     port: 80
#     protocol: TCP
# ---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: default
data:
  nginx.conf: |
    events {}

    http {
    set_real_ip_from 0.0.0.0/0;      
    real_ip_header X-Forwarded-For;  
    real_ip_recursive on;

    server {
        listen 80;

        location / {
            default_type text/html;
            return 200 '
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>IP Info</title>
                    <style>
                        body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; padding: 2em; }
                        .container { background: #fff; border-radius: 8px; padding: 2em; max-width: 400px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                        h1 { text-align: center; color: #007acc; }
                        p { font-size: 1.2em; }
                        .label { font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>IP Info</h1>
                        <p><span class="label">Client IP:</span> $remote_addr</p>
                        <p><span class="label">Server IP:</span> $server_addr</p>
                    </div>
                </body>
                </html>
            ';
        }
    }
    } 

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: default
spec:
  selector:
    matchLabels:
      app: nginx
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx:latest
        name: nginx
        ports:
        - containerPort: 80
          name: web
        volumeMounts:
          - name: config-vol
            mountPath: /etc/nginx/
      volumes:
        - name: config-vol
          configMap:
            name: nginx-config
            items:
              - key: nginx.conf
                path: nginx.conf