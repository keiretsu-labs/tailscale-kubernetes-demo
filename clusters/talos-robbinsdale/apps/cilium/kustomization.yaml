apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

helmCharts:
  - name: cilium
    repo: https://helm.cilium.io/
    version: 1.16.6
    namespace: kube-system
    releaseName: cilium
    includeCRDs: true
    valuesFile: values.yaml
    apiVersions:
      - monitoring.coreos.com/v1

resources:
  - nodelocaldns.yaml
  - generic-device-plugin.yaml
  - https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset-thick.yml
  - https://raw.githubusercontent.com/s1061123/cni-dhcp-daemon/015bf0b6c80d8ce664ef647dacfbae91e28e0d95/kube-dhcp-ds.yml

patches:
  - target:
      kind: DaemonSet
      name: kube-multus-ds
      namespace: kube-system
    patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-multus-ds
        namespace: kube-system
      spec:
        template:
          spec:
            volumes:
              - name: host-run-netns
                hostPath:
                  path: /var/run/netns/
            initContainers:
              - name: install-multus-binary
                image: ghcr.io/k8snetworkplumbingwg/multus-cni:snapshot-thick
                command:
                  - "cp"
                  - "-f"
                  - "/usr/src/multus-cni/bin/multus-shim"
                  - "/host/opt/cni/bin/multus-shim"
            containers:
              - name: kube-multus
                resources:
                  requests:
                    cpu: "100m"
                    memory: "200Mi"
                  limits:
                    cpu: "100m"
                    memory: "50Mi"