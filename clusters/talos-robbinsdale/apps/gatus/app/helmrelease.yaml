---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gatus
spec:
  interval: 30m
  chart:
    spec:
      chart: gatus
      version: 1.3.0 # Pinned version from original kustomization
      sourceRef:
        kind: HelmRepository
        name: twin
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      tag: latest
    envFrom:
      - secretRef:
          name: gatus
      # - secretRef:
      #     name: gatus-postgres-app
    config:
      #storage:
        #type: postgres
        #path: "$${uri}"
      alerting:
        discord:
          webhook-url: "$${discord-webhook-url}"
          failure-threshold: 3
          success-threshold: 2
      ui:
        title: "K8s-Robbinsdale Cluster Status"
        description: "GitOps-managed Kubernetes cluster monitoring - Single source of truth for infrastructure health"
        header: "K8s-Robbinsdale Infrastructure Dashboard"
        logo: "https://raw.githubusercontent.com/kubernetes/kubernetes/master/logo/logo.png"
        link: "https://github.com/rajsinghtech/kubernetes-manifests"
        buttons:
          - name: "GitOps Repository"
            link: "https://github.com/rajsinghtech/kubernetes-manifests"
          - name: "ArgoCD"
            link: "https://argocd.rajsingh.info"
          - name: "Grafana"
            link: "https://grafana.lukehouge.com"
          - name: "Prometheus"
            link: "https://prometheus.lukehouge.com"
          - name: "Portfolio"
            link: "https://www.rajsingh.info"
        custom-css: |
          .header {
            background: linear-gradient(135deg, #d2b48c 0%, #daa520 100%);
          }
          .logo img {
            border-radius: 8px;
            max-height: 40px;
          }
          .btn-primary {
            background: linear-gradient(135deg, #d2b48c 0%, #daa520 100%);
            border: none;
            border-radius: 6px;
            margin: 0 5px;
          }
          .btn-primary:hover {
            background: linear-gradient(135deg, #daa520 0%, #d2b48c 100%);
            transform: translateY(-2px);
            transition: all 0.3s ease;
          }
      endpoints:
        - name: Silver
          group: servers
          url: tcp://silver.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Kubernetes API
          group: kubernetes
          url: https://k8s.robbinsdale.local:6443/readyz
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[STATUS] == 401"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Tank
          group: servers
          url: tcp://tank.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Titan
          group: servers
          url: tcp://titan.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Stone
          group: servers
          url: tcp://stone.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Vault
          group: servers
          url: tcp://vault.local:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Ubiquiti UNAS Pro
          group: servers
          url: https://nas.local
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Portfolio - Raj Singh
          group: website
          url: https://www.rajsingh.info
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Immich
          group: home
          url: http://immich-server.immich:2283/api/server/ping
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Cloudflared Tunnel
          group: network
          url: https://status.rajsingh.info
          client:
            dns-resolver: "tcp://1.1.1.1:53"
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy Public
          group: network
          url: https://gatus.rajsingh.info
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy Private
          group: network
          url: https://status.rajsingh.info
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy Tailscale
          group: network
          url: https://gatus.ts.rajsingh.info
          client:
            dns-resolver: "tcp://pihole-home-robbinsdale.keiretsu.ts.net:53"
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Portfolio - Luke Houge
          group: website
          url: https://www.lukehouge.com
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyfin
          group: media
          url: http://jellyfin.media:8096/health
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellystat
          group: media
          url: http://jellystat.media:3000
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyseerr
          group: media
          url: http://jellyseerr.media:5055
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: PiHole Home DNS
          group: network
          url: "pihole-dns.home"
          dns:
            query-name: "google.com"
            query-type: "A"
          conditions:
            - "[DNS_RCODE] == NOERROR"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: PiHole Tailscale DNS
          group: network
          url: "pihole-ts-dns.keiretsu"
          dns:
            query-name: "google.com"
            query-type: "A"
          conditions:
            - "[DNS_RCODE] == NOERROR"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Frigate
          group: home
          url: https://frigate.lukehouge.com
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Homeassistant
          group: home
          url: https://homeassistant.lukehouge.com
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true 