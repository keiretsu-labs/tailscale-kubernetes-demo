---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cilium
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: cilium
      version: 1.15.7
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    # enterprise:
    #   multiNetwork:
    #     # Enables native multi-network support in Cilium (default: false)
    #     enabled: true
    #     # Enable auto-creation of the default pod network (default: true)
    #     autoCreateDefaultPodNetwork: true
    #     # Enable support for multi-network aware auto-direct-node-routes (default: true)
    #     autoDirectNodeRoutes: true
    routingMode: native
    endpointRoutes:
      enabled: true
    extraConfig:
      external-dns-proxy: "true"
      export-file-path: "/var/run/cilium/hubble/hubble.log"
      # Disable local node route to avoid conflicts with endpoint routes
      enable-local-node-route: "false"
    bpf:
      datapathMode: netkit
      masquerade: true
    ipv6:
      enabled: false
    # enableIPv6BIGTCP: true
    ipv4:
      enabled: true
    # enableIPv4BIGTCP: true
    kubeProxyReplacement: true
    prometheus:
      enabled: true
    operator:
      replicas: 1
      prometheus:
        enabled: true
    # cni:
    #   exclusive: false
    cluster:
      id: ${CLUSTER_ID}
      name: ${CLUSTER_NAME}
    bgpControlPlane:
      enabled: true
    ipv4NativeRoutingCIDR: "10.43.0.0/16"
    devices: ["eth+"]
    k8s-require-ipv4-pod-cidr: true
    # ipam:
    #   # Multi-network requires multi-pool IPAM
    #   mode: multi-pool
    #   # Configuration of the "default" IP pool used for the "default" pod network
    #   operator:
    #     autoCreateCiliumPodIPPools:
    #       default:
    #         ipv4:
    #           cidrs: ["10.43.0.0/16"]
    #           maskSize: 24
    tunnel: vxlan
    externalIPs:
      enabled: true
    hostPort:
      enabled: true
    hostServices:
      enabled: false
    envoy:
      enabled: true
    envoyConfig:
      enabled: true
    loadBalancer:
      l7:
        backend: envoy
    egressGateway:
      enabled: true
    l2announcements:
      enabled: true
      leaseDuration: 3s
      leaseRenewDeadline: 1s
      leaseRetryPeriod: 500ms
    l2podAnnouncements:
      enabled: true
      interface: eth1
    k8sServiceHost: 127.0.0.1
    k8sServicePort: 6443
    k8sClientRateLimit:
      qps: ${QPS}
      burst: ${BURST}
    tunnelProtocol: vxlan
    # hostFirewall:
    #   enabled: true
    hubble:
      enabled: true
      relay:
        enabled: true
      tls:
        enabled: true
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: hubble-ui
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: hubble-ui
      version: x
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    timescape:
      enabled: true
      address: "hubble-timescape.hubble-timescape"
    # grafana:
    #   enabled: true
    #   enabledNodesGraph: true
    #   namespace: "monitoring"
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: hubble-enterprise
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: hubble-enterprise
      version: x
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    enabled: true
    dnsPolicy: ClusterFirstWithHostNet

    enterprise:
      enabled: false

    export:
      filenames:
      - tetragon-flows.log
      - tetragon.log
      - hubble.log
      mode: fluentd
      fluentd:
        output: |-
          @type http
          endpoint http://hubble-timescape-ingester.hubble-timescape.svc.cluster.local:4260/push
          http_method post
          <format>
            @type json
          </format>
          <buffer>
            flush_interval 1s
          </buffer>
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: tetragon
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: tetragon
      version: x
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    ipMasqAgent:
      enabled: true
    tetragon:
      btf: /sys/kernel/btf/vmlinux
      enabled: true
      exportAllowList: ""
      exportDenyList: |-
        {"ip_cidr":["127.0.0.1","::1"]}
      redactionFilters: |-
        {"redact": ["\\b(MY_SECRET_VALUE)\\b"]}
      enableProcessCred: true
      enableProcessNs: true
      extraArgs:
        verbose: "3"
        release-pinned-bpf: true
        detach-old-bpf: true
        rb-size: "98304"
      flowExportFilename: tetragon-flows.log
      prometheus:
        serviceMonitor:
          enabled: true
    tetragonOperator:
      prometheus:
        serviceMonitor:
          enabled: true
    tracingPolicies:
      default:
        fim:
          enabled: true
        network:
          enabled: false # Custom policies are installed separately via tracing-policies app
        mount:
          enabled: true
        osi:
          enabled: true
        privileges:
          enabled: true
    exportDirectory: "/var/run/cilium/hubble"
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cilium-dnsproxy
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: cilium-dnsproxy
      version: 1.15.7
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
