---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cilium
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: cilium
      version: 1.15.7
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    routingMode: native
    bpf:
      datapathMode: netkit
      masquerade: true
    ipv6:
      enabled: false
    # enableIPv6BIGTCP: true
    ipv4:
      enabled: true
    # enableIPv4BIGTCP: true
    kubeProxyReplacement: true
    prometheus:
      enabled: true
    operator:
      replicas: 1
      prometheus:
        enabled: true
    cni:
      exclusive: false
    cluster:
      id: ${CLUSTER_ID}
      name: ${CLUSTER_NAME}
    bgpControlPlane:
      enabled: true
    ipv4NativeRoutingCIDR: "10.42.0.0/16"
    k8s-require-ipv4-pod-cidr: true
    ipam:
      mode: kubernetes
    tunnel: vxlan
    externalIPs:
      enabled: true
    hostPort:
      enabled: true
    hostServices:
      enabled: false
    envoy:
      enabled: true
    envoyConfig:
      enabled: true
    loadBalancer:
      l7:
        backend: envoy
    egressGateway:
      enabled: true
    l2announcements:
      enabled: true
      leaseDuration: 3s
      leaseRenewDeadline: 1s
      leaseRetryPeriod: 500ms
    k8sServiceHost: 127.0.0.1
    k8sServicePort: 6443
    k8sClientRateLimit:
      qps: ${QPS}
      burst: ${BURST}
    tunnelProtocol: vxlan
    extraConfig:
      external-dns-proxy: "true"
      export-file-path: "/var/run/cilium/hubble/hubble.log"
    # hostFirewall:x
    #   enabled: true
    hubble:
      eventBufferCapacity: "65535"
      listenAddress: ""
      # tls:
      #   enabled: true
      #   auto:
      #     enabled: true
      #     method: certmanager
      #     # certs are valid for 1 day
      #     certValidityDuration: 1
      #     certManagerIssuerRef:
      #       group: cert-manager.io
      #       kind: ClusterIssuer
      #       name: hubble-issuer
      relay:
        enabled: true
        # resources:
        #   requests:
        #     cpu: 500m
        #     memory: 50Mi
        #   limits:
        #     memory: 100Mi
        # tls:
        #   server:
        #     enabled: true
        dialTimeout: 30s
      metrics:
        dashboards:
          enabled: true
          namespace: monitoring
          annotations:
            grafana_folder: "Hubble"
        enableOpenMetrics: true
        enabled:
          - "dns:query;ignoreAAAA;labelsContext=source_namespace,source_workload,destination_namespace,destination_workload;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          - "drop:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          - "flow:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          - "flows-to-world:labelsContext=source_namespace,source_workload;sourceContext=workload-name|pod-name|dns|reserved-identity"
          - "httpV2:exemplars=true;labelsContext=source_namespace,source_workload,source_app,destination_namespace,destination_workload,destination_app,traffic_direction;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          - "icmp:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          - "kafka:labelsContext=source_namespace,source_workload,source_app,destination_namespace,destination_workload,destination_app,traffic_direction;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          - "policy:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          - "tcp:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload;sourceContext=workload-name|pod-name|dns|reserved-identity;destinationContext=workload-name|pod-name|dns|reserved-identity"
          # enterprise only metrics
          - "flow_export:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload"
        serviceMonitor:
          enabled: true
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: hubble-ui
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: hubble-ui
      version: x
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    timescape:
      enabled: true
      address: "hubble-timescape.hubble-timescape"
    # grafana:
    #   enabled: true
    #   enabledNodesGraph: true
    #   namespace: "monitoring"
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: hubble-enterprise
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: hubble-enterprise
      version: x
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    enabled: true
    dnsPolicy: ClusterFirstWithHostNet

    enterprise:
      enabled: false

    export:
      filenames:
      - tetragon-flows.log
      - tetragon.log
      - hubble.log
      mode: fluentd
      fluentd:
        output: |-
          @type http
          endpoint http://hubble-timescape-ingester.hubble-timescape.svc.cluster.local:4260/push
          http_method post
          <format>
            @type json
          </format>
          <buffer>
            flush_interval 1s
          </buffer>
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: tetragon
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: tetragon
      version: x
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values:
    tetragon:
      btf: /sys/kernel/btf/vmlinux
      enabled: true
      exportAllowList: ""
      exportDenyList: |-
        {"ip_cidr":["127.0.0.1","::1"]}
      redactionFilters: |-
        {"redact": ["\\b(MY_SECRET_VALUE)\\b"]}
      enableProcessCred: true
      enableProcessNs: true
      extraArgs:
        verbose: "3"
        release-pinned-bpf: true
        detach-old-bpf: true
        rb-size: "98304"
      flowExportFilename: tetragon-flows.log
      prometheus:
        serviceMonitor:
          enabled: true
    tetragonOperator:
      prometheus:
        serviceMonitor:
          enabled: true
    tracingPolicies:
      default:
        fim:
          enabled: true
        network:
          enabled: false # Custom policies are installed separately via tracing-policies app
        mount:
          enabled: true
        osi:
          enabled: true
        privileges:
          enabled: true
    exportDirectory: "/var/run/cilium/hubble"
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cilium-dnsproxy
  namespace: kube-system
spec:
  interval: 2m
  chart:
    spec:
      chart: cilium-dnsproxy
      version: 1.15.7
      sourceRef:
        kind: HelmRepository
        name: isovalent
  values: