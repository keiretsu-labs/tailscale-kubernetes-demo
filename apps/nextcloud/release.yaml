---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nextcloud
spec:
  interval: 2m
  chart:
    spec:
      chart: nextcloud
      version: x
      sourceRef:
        kind: HelmRepository
        name: nextcloud
  values:
    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: global-issuer
        kubernetes.io/tls-acme: "true"
      tls:
        - secretName: nextcloud-tls
          hosts:
            - nextcloud.${INGRESS_DOMAIN}
      labels: {}
      path: /
      pathType: Prefix
    nextcloud:
      host: nextcloud.${INGRESS_DOMAIN}
      configs:
        logging.config.php: |-
          <?php
          $CONFIG = array (
            'log_type' => 'file',
            'logfile' => 'nextcloud.log',
            'loglevel' => 0,
            'logdateformat' => 'F d, Y H:i:s'
            );
    persistence:
      # Nextcloud Data (/var/www/html)
      enabled: false
      annotations: {}
      storageClass: "nfs-client"
    hpa:
      enabled: true
      cputhreshold: 60
      minPods: 1
      maxPods: 10
    redis:
      enabled: true
      auth:
        enabled: true
    postgresql:
      enabled: true
      global:
        postgresql:
          # global.postgresql.auth overrides postgresql.auth
          auth:
            username: nextcloud
            password: changeme
            database: nextcloud
            # Name of existing secret to use for PostgreSQL credentials.
            # auth.postgresPassword, auth.password, and auth.replicationPassword will be ignored and picked up from this secret.
            # secret might also contains the key ldap-password if LDAP is enabled.
            # ldap.bind_password will be ignored and picked from this secret in this case.
            existingSecret: ""
            # Names of keys in existing secret to use for PostgreSQL credentials
            secretKeys:
              adminPasswordKey: ""
              userPasswordKey: ""
              replicationPasswordKey: ""
      primary:
        persistence:
          enabled: false
          # Use an existing Persistent Volume Claim (must be created ahead of time)
          # existingClaim: ""
          storageClass: "nfs-client"
