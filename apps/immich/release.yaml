---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: immich
spec:
  interval: 2m
  chart:
    spec:
      chart: immich
      version: x
      sourceRef:
        kind: HelmRepository
        name: immich
  postRenderers:
    - kustomize:
        patches:
          - target:
              version: v1
              kind: Deployment
              name: immich-server
            patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: immich-server
                namespace: immich
              spec:
                template:
                  spec:
                    volumes:
                      - name: hack
                        persistentVolumeClaim:
                          claimName: immich-hack-pics
                    containers:
                      - name: immich-server
                        volumeMounts:
                          - name: hack
                            mountPath: /hack/pics
  values:
    # env:
    # - name: DB_DATABASE_NAME
    #   value: immich
    # - name: DB_HOSTNAME
    #   valueFrom:
    #     secretKeyRef:
    #       name: immich-postgresql-app
    #       key: host
    # - name: DB_PASSWORD
    #   valueFrom:
    #     secretKeyRef:
    #       name: immich-postgresql-app
    #       key: password
    # - name: DB_USERNAME
    #   valueFrom:
    #     secretKeyRef:
    #       name: immich-postgresql-app
    #       key: username
    # - name: REDIS_HOSTNAME
    #   value: immich-redis-headless
    immich:
      metrics:
        # Enabling this will create the service monitors needed to monitor immich with the prometheus operator
        enabled: false
      persistence:
        library:
          existingClaim: immich

    # # Dependencies
    postgresql:
      enabled: true

    # redis:
    #   enabled: true
      
    microservices:
      persistence:
        external:
          external:
            enabled: true
            existingClaim: immich-hack-pics
            readOnly: true    
    
    server:
      persistence:
        external:
          external:
            enabled: true
            existingClaim: immich-hack-pics
            readOnly: true
      ingress:
        main:
          enabled: true
          ingressClassName: haproxy
          annotations:
            cert-manager.io/cluster-issuer: global-issuer
          hosts:
            - host: "immich.${INGRESS_DOMAIN}"
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: immich-tls
              hosts:
                - immich.${INGRESS_DOMAIN}
