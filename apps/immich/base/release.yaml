---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
spec:
  interval: 2m
  chart:
    spec:
      chart: immich
      version: x
      sourceRef:
        kind: HelmRepository
        name: immich
  values:
    image:
      tag: v1.115.0
    # env:
    # - name: DB_DATABASE_NAME
    #   value: immich
    # - name: DB_HOSTNAME
    #   valueFrom:
    #     secretKeyRef:
    #       name: immich-postgresql-app
    #       key: host
    # - name: DB_PASSWORD
    #   valueFrom:
    #     secretKeyRef:
    #       name: immich-postgresql-app
    #       key: password
    # - name: DB_USERNAME
    #   valueFrom:
    #     secretKeyRef:
    #       name: immich-postgresql-app
    #       key: username
    # - name: REDIS_HOSTNAME
    #   value: immich-redis-headless
    immich:
      metrics:
        # Enabling this will create the service monitors needed to monitor immich with the prometheus operator
        enabled: false
      persistence:
        library:
          existingClaim: immich

    # # Dependencies
    postgresql:
      enabled: true

    # redis:
    #   enabled: true

    microservices:
      persistence:
        external:
          external:
            enabled: true
            existingClaim: immich-hack-pics
            readOnly: true

    server:
      persistence:
        external:
          external:
            enabled: true
            existingClaim: immich-hack-pics
            readOnly: true
      ingress:
        main:
          enabled: true
          ingressClassName: haproxy
          annotations:
            cert-manager.io/cluster-issuer: global-issuer
          hosts:
            - host: "immich.${INGRESS_DOMAIN}"
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: immich-tls
              hosts:
                - immich.${INGRESS_DOMAIN}
